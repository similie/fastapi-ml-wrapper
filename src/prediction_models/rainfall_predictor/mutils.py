from os import path, listdir
## Imports for plotting
import matplotlib.pyplot as plt
import matplotlib
import matplotlib.ticker as ticker
import seaborn as sns
from time import time

import torch
import pandas as pd

def get_checkpoint_filepath(model_prefix: str = "FC",
                            latent_dim: int = 128, 
                            checkpoint_path: str ="results"):
    prefixes = ["FC", "AE"]
    if model_prefix not in prefixes:
        raise ValueError("Invalid prefix. Expected one of: %s" % prefixes)
    project_root = path.dirname(__file__)
    filename = listdir(path.join(project_root, 
                        checkpoint_path,
                        f"{model_prefix}_model{latent_dim}",
                        "version_0/checkpoints"))[0]
    
    return path.join(project_root, 
                    checkpoint_path,
                    f"{model_prefix}_model{latent_dim}",
                    "version_0/checkpoints",
                    filename)  

def plot_loss(model_dict, check_pt_path):
    latent_dims = sorted([k for k in model_dict])
    # THIS NEEDS FIXING: test: test_loss/dataloader_idx
    val_scores = [model_dict[k]["result"]["val"][0]["test_loss"] for k in latent_dims]

    fig = plt.figure(figsize=(6,4))
    plt.plot(latent_dims, val_scores, '--', color="#000", marker="*", markeredgecolor="#000", markerfacecolor="y", markersize=16)
    plt.xscale("log")
    plt.xticks(latent_dims, labels=latent_dims)
    plt.title("Reconstruction error over latent dimensionality", fontsize=12)
    plt.xlabel("Latent dimensionality")
    plt.ylabel("Reconstruction error")
    plt.minorticks_off()
    plt.ylim(0,100)
    # plt.savefig(check_pt_path + 'loss.pdf')
    plt.show()

def plot_predictions(preds: dict, target: str = "precipitation"):
    """
        Plot predictions generated by models
        for all the stations. Saves plot as 
        pdf in the results file.
    """
    sns.set_style('darkgrid')
    sns.set(rc={'figure.figsize':(14,8)})
    df_list = []
    for s, _df in preds.items():
        _df['station'] = s
        df_list.append(_df)

    concat_df = pd.concat(df_list).sort_index()
    ax = sns.lineplot(data=concat_df, 
                      x = concat_df.index, 
                      y = concat_df[target],
                      hue=concat_df['station'], palette='viridis',
                      legend='full', 
                      lw=3)
    ax.xaxis.set_major_locator(ticker.AutoLocator())
    ax.set(ylim=(-.01, 1))
    plt.legend(bbox_to_anchor=(1, 1))
    plt.ylabel('rainfall (mm)')
    plt.xlabel('month-day-hour')
    filename = f"./results/predictions{int(time())}.pdf"
    plt.savefig(filename)
    # plt.show()
    

def reconstruction_predictions(model, input_data):
    """ 
        Not used as of yet. Look at generate_predictions
        in predict.py TODO add this to use the AE as a 
        data imputer at some stage.
        Inputs: 
            - trained AE model
            - input data (scaled tensors)        
        Reconstruct timeseries - shifted by 12 hours
        Can feed the predictions back into the model
        to get 24 hours, etc...
    """
    model.eval()
    with torch.no_grad():
        reconst_timeseries = model(input_data.to(model.device))
    reconst_timeseries = reconst_timeseries.cpu()
    return reconst_timeseries.numpy()

